<html>
    <head>
        <title>
            High-throughput sequencers
        </title>
        <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
        <style type="text/css">
            h1 {
                font-family: Georgia, Garamond;
            }
            h2 {
                font-family: Georgia, Garamond;
            }
            p {
                font-family: Arial;
            }
            ul {
                font-family: Arial;
            }
            .content {
                margin-left: 25px;
                margin-top: 10px;
            }

            .context {
                font-family:Arial, sans-serif;
                text-decoration:none;
                color:#4444ff;
                font-size:small;
            }

            a:hover div {
                background:#eee;
            }       
        </style>
        <link rel="stylesheet" type="text/css" href="{{static_path}}/css/smoothness/jquery-ui-1.7.2.custom.css">
        <link rel="stylesheet" type="text/css" href="{{static_path}}/css/styledButton.css" />

        <script type="text/javascript" src="{{static_path}}/js/jquery-1.3.2.min.js"></script>
        <script type="text/javascript" src="{{static_path}}/js/jquery-ui-1.7.2.custom.min.js"></script>
        <script type="text/javascript" src="{{static_path}}/js/jquery.styledButton.js"></script>

        <script type="text/javascript" src="http://maps.google.com/maps?file=api&amp;v=2&amp;key={{ google_api_key }}&sensor=false"></script>
        <script type="text/javascript" src="{{static_path}}/js/markerclusterer_packed.js"></script>

        <script type="text/javascript" src="{% url json-data %}"></script>
        <script type="text/javascript">
            var map;
            var markerClusterer = null;
            var mcOptions = {gridSize: 20, maxZoom: 8};
            var json_file = "data.json";
            var icon = new GIcon(G_DEFAULT_ICON);
            var clickPos;
            icon.image = "http://chart.apis.google.com/chart?cht=mm&chs=24x32&chco=FFFFFF,008CFF,000000&ext=.png";

            function createMarker(icon, d) {
                var latlng = new GLatLng(d.fields.lat, d.fields.long);
                var marker = new GMarker(latlng, {icon: icon});
                var html = "<b><a href=\"/hts/centres/" + d.fields.slug + "/\">" + d.fields.name + "</a></b><p>" + d.fields.notes + "</p>";
                GEvent.addListener(marker, 'click', function() {
                    marker.openInfoWindowHtml(html);
                });
                return marker;
            }

            function init_platform_controls() {
                for (var i = 0; i < platforms.length; ++i) {
                    var id = "platform" + platforms[i].pk;
                    $('#platformbuttons').append(
                        "<span class=\"platformbutton\" id=\"" + id + "\">" + platforms[i].fields.short_name + "</span>"
                    );
                    $('#' + id).styledButton({
                        'orientation' : 'center',
                        'role' : 'checkbox',
                        'checked' : true
                    }).bind("click", function() {
                        refreshmap();
                    });
                }
            }

            function addcenter() {
                window.location.replace("{% url add-centre %}" + "?lat=" + clickPos.lat() + "&long=" + clickPos.lng());
            }

            function initialize() {
                var mapOptions = { googleBarOptions : { style : "new" } };
 
                map = new GMap2(document.getElementById('map'), mapOptions);

                map.setCenter(new GLatLng(24.5271348, 15.8203125), 2);
                
                map.addControl(new GLargeMapControl());
                map.addControl(new GMapTypeControl());

                map.enableGoogleBar();

                var contextmenu = document.createElement("div");
                contextmenu.style.visibility = "hidden";
                contextmenu.style.background = "#ffffff";
                contextmenu.style.border = "1px solid #8888FF";
                contextmenu.style.margin = "5px";

                contextmenu.innerHTML = '<a href="javascript:addcenter()"><div class="context">&nbsp;&nbsp;Add a new centre&nbsp;&nbsp;</div></a>';

                map.getContainer().appendChild(contextmenu);

                GEvent.addListener(map,"singlerightclick",function(pixel,tile) {
                    clickedPixel = pixel;
                    var x=pixel.x;
                    var y=pixel.y;
                    clickPos = map.fromContainerPixelToLatLng(pixel);
                    if (x > map.getSize().width - 120) { x = map.getSize().width - 120 }
                    if (y > map.getSize().height - 100) { y = map.getSize().height - 100 }
                    var pos = new GControlPosition(G_ANCHOR_TOP_LEFT, new GSize(x,y));  
                    pos.apply(contextmenu);
                    contextmenu.style.visibility = "visible";
                });

                GEvent.addListener(map, "click", function() {
                    contextmenu.style.visibility = "hidden";
                });

                var markers = [];
                for (var i = 0; i < data.length; ++i) {
                    markers.push(createMarker(icon, data[i]));
                }

                markerCluster = new MarkerClusterer(map, markers, mcOptions);

                init_platform_controls();
            }

            function getbuttonstate() {
                var state = Array();
                $('.platformbutton').each(function(but) {
                    state.push([$(this).attr('id').replace('platform', ''), $(this).val()]);
                });
                return state;
            }

            function refreshmap() {
                if (markerCluster != null) {
                    markerCluster.clearMarkers();
                }

                var platforms = new Object();

                state = getbuttonstate();
                for (var i = 0; i < state.length; ++i) {
                    if(state[i][1] == 'on') {
                        platform_id = state[i][0];
                        for (var j = 0; j < capabilities.length; ++j) {
                            if(capabilities[j].fields.platform == platform_id) {
                                platforms[capabilities[j].fields.centre] = 1;
                            }
                        }
                    }
                }

                var markers = [];
                for (var i = 0; i < data.length; ++i) {
                    if(platforms[data[i].pk]) {
                        markers.push(createMarker(icon, data[i]));
                    }
                }

                markerCluster = new MarkerClusterer(map, markers, mcOptions);
            }

            function set_map_centre(country) {
                for (var i = 0; i < countries.length; i++) {
                    if(countries[i].fields.name == country) {
                        c = countries[i].fields;

                        bnds = new GLatLngBounds(new GLatLng(c.sw_lat, c.sw_long), new GLatLng(c.ne_lat, c.ne_long));
                        map.setCenter(bnds.getCenter());
                        map.setZoom(map.getBoundsZoomLevel(bnds));

                        break;
                    }
                }
            }

            function display_coords() {
                window.alert("lat, lon " + map.getCenter().lat() + ' ' + map.getCenter().lng());
            }


            function fixTiles(){
                var tiles = document.getElementsByTagName('IMG');
                for (var n = 0 ; n < tiles.length ; n++ ) {
                    if (tiles[n].src.match(/&src=api/)) {
                        tiles[n].src = tiles[n].src.replace(/&src=api/,'');
                    }
                }
                window.setTimeout("fixTiles()",500);
            }

            $(document).ready(function() {
                {% if centre_mode %}
                    $("#tabs").tabs({selected: 2});
                {% else %}
                    $("#tabs").tabs();
                {% endif %}

                initialize();
                $('#countrylist').change(function() {
                    set_map_centre($(this).val());
                });

                $('#tabs').bind('tabsshow', function(event, ui) {
                    if (ui.panel.id == "map-tab") {
                        map.checkResize();
                        map.setCenter(new GLatLng(24.5271348, 15.8203125), 2);
                    }
                });

/*                fixTiles(); */
            });


        </script>
    </head>
    <body onunload="GUnload()">
        <h1>Genomics: High-throughput Sequencing Facilities</h1>

        <div id="main">
            {% regroup centres by country as country_list %}
            <div id="tabs">
                <ul>
                    <li><a href="#map-tab">Map</a></li>
                    <li><a href="#tabs-2">Browse</a></li>
                    {% if centre_mode %}
                    <li><a href="#tabs-3">{{ c.name }}</a></li>
                    {% endif %}
                </ul>
                <div id="map-tab">
                    <div id="control" style="width: 18%; float: right;">
                        <h2>Filter Controls</h2>
                        <div id="platformbuttons">
                        </div>
                        <p>
                            Jump to country
                        </p>
                        <select id="countrylist">
                            <option>--
                            {% for country in country_list %}
                            <option>{{country.grouper}}
                            {% endfor %}
                        </select>
                    </div>
                    <div id="map" style="width: 80%; height: 600px"></div>
                </div>
                <div id="tabs-2">
                    <div>
                {% for country in country_list %}
                <h2>{{ country.grouper }}</h2>
                <ul>
                    {% for c in country.list %}
                    <li><a href="{% url centre c.slug %}">{{ c }}</a>
                    {% endfor %}
                </ul>
                {% endfor %}
                    </div>
                </div>
                {% if centre_mode %}
                <div id="tabs-3">
                    <span class="content">
                        <h1>{{ c.name }}</h1>
                        <p>
                            <a href="{% url centre-update c.slug %}">Update this centre's details</a>
                        </p>
                        <p id="url">
                            Visit this centre's website: <a href="{{ c.url }}">{{ c.url }}</a>
                        </p>
                        <p id="notes">
                            {{ c.notes }}
                        </p>
                        {% if c.service_facility %}
                        <p>
                            This facility offers a sequencing service to the public.
                        </p>
                        {% endif %}

                        {% if c.dedicated_genome_centre %}
                        <p>
                            This facility is a dedicated genome centre.
                        </p>
                        {% endif %}

                        {% if c.contact_name %}
                        <h2>Contact Details</h2>

                        <p id="contact_name">
                            Contact <a href="{{ c.contact_email }}">{{ c.contact_name }}</a> for further details.
                        </p>
                        {% endif %}
                        <h2>Capacity</h2>

                        <p>This facility has the following capacity:
                        <ul>
                        {% for cap in capacity %}
                            <li><a href="{% url platform p_slug=cap.platform.slug %}">{{ cap.platform.long_name }}</a>
                            {% if cap.number_machines %}
                                ({{ cap.number_machines }} machine{{ cap.number_machines|pluralize}})
                            {% endif %}
                        {% endfor %}
                        </ul>
                    </span> 
                </div>
                {% endif %}
            </div>
        </div>
        <div id="footer">
            <p>
                The High-Throughput Sequencing Map site was conceived by
                <a href="http://www.cancer.cam.ac.uk/directory/profile.php?jamesh008">James Hadfield</a>
                (Cancer Research UK, Cambridge) and built by
                <a href="http://pathogenomics.bham.ac.uk/blog">Nick Loman</a> (University of Birmingham).
                This site utilises the Google Maps API, JQuery, MarkerClusterer, Styled Buttons, Django and SQLite - thanks!
            </p>
        </div>
    </body>
</html>
